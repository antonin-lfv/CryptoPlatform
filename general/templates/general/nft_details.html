<!DOCTYPE html>
<html lang="en">
<head>
    {% include('includes/head_content.html') %}
    <title>NFT marketplace</title>

</head>
<body class="layout-top-nav {% if session['theme'] == 'dark' %}dark-skin{% else %}light-skin{% endif %} theme-primary fixed">

<div class="wrapper">
    <div id="loader"></div>

    <!-- Top navbar -->
    {% include('includes/top_navbar.html') %}

    <!-- Navbar -->
    {% include('includes/navbar.html') %}
    <div class="content-wrapper">
        <div class="container-full">
            <!-- Content Header (Page header) -->
            <div class="content-header">
                <div class="d-flex align-items-center">
                    <div class="me-auto">
                        <h4 class="page-title">{{ nft_data['name'] }} details</h4>
                        <div class="d-inline-block align-items-center">
                            <nav>
                                <ol class="breadcrumb">
                                    <li class="breadcrumb-item"><a href="#"><i class="mdi mdi-home-outline"></i></a>
                                    </li>
                                    <li class="breadcrumb-item" aria-current="page"><a
                                            href="{{ url_for('BLP_general.nft_marketplace') }}">NFT marketplace</a></li>
                                    <li class="breadcrumb-item active" aria-current="page">{{ nft_data['name'] }}</li>
                                </ol>
                            </nav>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Main content -->
            <section class="content">
                <div class="row">
                    <div class="col-xl-5 col-lg-5">
                        <!-- Profile Image -->
                        <img class="rounded img-fluid mx-auto d-block"
                             src="{{ url_for('static', filename=nft_data['image_path']) }}"
                             alt="User profile picture">
                    </div>
                    <!-- /.col -->
                    <div class="col-xl-7 col-lg-7">
                        <div class="col-12">
                            <div class="box">
                                <div class="box-header with-border">
                                    <h4 class="box-title">NFT details</h4>
                                </div>
                                <div class="box-body">
                                    <a href="{{ url_for('BLP_general.nft_marketplace', collection=nft_data['collection']) }}">Collection {{ nft_data['collection'] }}</a><br>
                                    <br>
                                    <h3 class="box-title">{{ nft_data['name'].split(' ')[1] }}</h3><br>
                                    <H4 id="owned_status"></H4>&nbsp;<h5 id="set_as_profile_picture"></h5>

                                    <h6>Current price</h6>
                                    <h4><b><a id="NFT_price">{{ nft_data['price'] }}</a>&nbsp;<a id="NFT_symbol">ETH</a></b>&nbsp;<small class="fs-11 mb-0 text-uppercase text-mute">($<a id="NFT_price_USD">{{ nft_data['price_usd'] }}</a>)</small></h4>


                                </div>
                                <div class="box-body">
                                    <ul class="list-inline mb-0 me-2">
                                        <li class="list-inline-item">
                                            <a href="#" onclick="like_nft({{ nft_data['id'] }})"><i class="fa fa-heart{{ nft_data['liked'] }}"></i>&nbsp;<a id="number_likes">{{ nft_data['number_of_likes'] }} </a> favorite{% if nft_data['number_of_likes']>1 %}s{% endif %}</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div id="nft_data"
                                 data-owned="{{ nft_data['owned'] }}"
                                 data-is_for_sale="{{ nft_data['is_for_sale'] }}">
                            </div>

                            <div class="box" id="buy_box" style="display:none;">
                                <div class="box-header with-border">
                                    <h4 class="box-title">Buy</h4>
                                </div>
                                <div class="box-body">

                                    <div class="clearfix" style="display: flex;">
                                        <button type="button" style="width: 100%; box-sizing: border-box; margin-top: 10px;" class="waves-effect waves-light btn btn-primary mb-5" data-bs-toggle="modal" data-bs-target="#buy_NFT">Buy now</button>
                                    </div>
                                </div>
                            </div>
                            <div class="box" id="sell_box" style="display:none;">
                                <div class="box-header with-border">
                                    <h4 class="box-title">Sell</h4>
                                </div>
                                <div class="box-body">

                                    <div class="clearfix" style="display: flex;">
                                        <button type="button" style="width: 100%; box-sizing: border-box; margin-top: 10px;" class="waves-effect waves-light btn btn-secondary mb-5" data-bs-toggle="modal" data-bs-target="#sell_NFT">Sell Now</button>
                                    </div>
                                </div>
                            </div>
                            <div class="box">
                                <div class="box-header with-border">
                                    <h4 class="box-title">Bid</h4>
                                </div>
                                <div class="box-body">
                                    <div class="table-responsive">
                                        <div id="bids_table">

                                        </div>
                                    </div>
                                    <div class="clearfix" style="display: flex;">
                                        <button type="button" style="width: 100%; box-sizing: border-box; margin-top: 10px;" class="waves-effect waves-light btn btn-primary mb-5" data-bs-toggle="modal" data-bs-target="#place_bid_modal" id="place_bid">Place a bid</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /.col -->
                </div>
                <!-- /.row -->

            </section>
            <!-- /.content -->

        </div>
    </div>

    <!-- Footer -->
    {% include('includes/footer.html') %}

</div>

<div id="buy_NFT" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel">Buy {{ nft_data['name'] }} NFT</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h5>You are going to pay {{ nft_data['price'] }} ETH </h5>
                <h6>You have {{ eth_amount['tokens'] }} ETH in your wallet</h6>
                <p>You will immediately receive your NFT after the sale.</p>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" data-bs-dismiss="modal"
                        id="validate_buy_NFT">Buy now
                </button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>

<div id="sell_NFT" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel">Buy {{ nft_data['name'] }} NFT</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h5>You are going to sell this NFT for {{ nft_data['price'] }} ETH </h5>
                <p>You will immediately receive your ETH after the sale.</p>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" data-bs-dismiss="modal"
                        id="validate_sell_NFT">Sell now
                </button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>

<div id="place_bid_modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel">Place a bid for {{ nft_data['name'] }} NFT</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h5>You are going to place a bid in ETH. </h5>
                <input type="text" id="bid_amount" value="0" class=" form-control" data-bts-button-down-class="btn btn-secondary" data-bts-button-up-class="btn btn-secondary">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" data-bs-dismiss="modal"
                        id="validate_place_bid">Place the bid
                </button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>



{% include('includes/javascript_include_dashboard.html') %}

<script>
function like_nft(nft_id) {
    // Requête AJAX à l'API Flask
    $.ajax({
        url: `/api/like_NFT/${nft_id}`,
        method: 'GET',
        success: function(response) {
            // change the heart icon, if class is fa fa-heart-o, change to fa fa-heart
            // if class is fa fa-heart, change to fa fa-heart-o
            var heartIcon = $(`a[onclick="like_nft(${nft_id})"] i`);
            var numberOfLikes = parseInt($('#number_likes').text());

            if (heartIcon.hasClass('fa-heart-o')) {
                heartIcon.removeClass('fa-heart-o');
                heartIcon.addClass('fa-heart');
                // compute the number of likes with the new number of likes
                numberOfLikes += 1;
                // update the number of likes
                $('#number_likes').text(numberOfLikes);

            } else {
                heartIcon.removeClass('fa-heart');
                heartIcon.addClass('fa-heart-o');
                // decrement the number of likes

                numberOfLikes -= 1;
                // update the number of likes
                $('#number_likes').text(numberOfLikes);
            }
        },
        error: function(error) {
            console.error('Error:', error);
        }
    });
}

// Buy NFT by calling /api/buy_NFT/<nft_id>
function buy_NFT(nft_id) {
    // Requête AJAX à l'API Flask
    $.ajax({
        url: `/api/buy_NFT/${nft_id}`,
        method: 'GET',
        success: function(response) {
            owned_status(nft_id);
            // change data-owned to true
            $('#nft_data').data('owned', 'True');
            // change data-is_for_sale to false
            $('#nft_data').data('is_for_sale', 'False');
            update_buy_sell_bid_box({{ nft_data['id'] }});
            swal(response['status'], response['message'], response['status']);
            if (response['refresh']){
                location.reload();
            }
        },
        error: function(error) {
            console.error('Error:', error['message']);
        }
    });
}

function sell_NFT(nft_id) {
    // Requête AJAX à l'API Flask
    $.ajax({
        url: `/api/sell_NFT/${nft_id}`,
        method: 'GET',
        success: function(response) {
            owned_status(nft_id);
            // update the image path
            var baseUrl = "{{ url_for('static', filename='') }}"; // Récupère la base de l'URL des fichiers statiques
            var newImagePath = baseUrl + response['image_path'] + '?v=' + new Date().getTime();
            $('#profile_picture_top_navbar').attr('src', newImagePath);
            // change data-owned to false
            $('#nft_data').data('owned', 'False');
            // change data-is_for_sale to true
            $('#nft_data').data('is_for_sale', 'True');
            // update the buy, sell box
            update_buy_sell_bid_box({{ nft_data['id'] }});
            swal(response['status'], response['message'], response['status']);

        },
        error: function(error) {
            console.error('Error:', error['message']);
        }
    });
}

// Validate buy NFT
$('#validate_buy_NFT').click(function() {
    buy_NFT({{ nft_data['id'] }});
});

// Validate sell NFT
$('#validate_sell_NFT').click(function() {
    sell_NFT({{ nft_data['id'] }});
});

// Get bids for this nft using /api/get_bids/<nft_id>
function get_bids(nft_id) {
    $.ajax({
        url: `/api/get_bids/${nft_id}`,
        method: 'GET',
        success: function(response) {
            if (response.length === 0) {
                $('#bids_table').html('<p>No bid yet</p>');
                return;
            }
            // Display the bids in a table
            var table = '<table class="table table-hover">';
            table += '<tr>';
            table += '<th>User</th>';
            table += '<th>Bid</th>';
            table += '<th>Date</th>';
            table += '<th></th>';
            table += '<th></th>';
            table += '</tr>';
            for (var i = 0; i < response.length; i++) {
                var bid = response[i];
                table += '<tr>';
                table += `<td><a href="javascript:void(0)">User #${bid['username']}</a></td>`;
                table += `<td>${bid['bid_price_crypto']} ${bid['bid_crypto_symbol']}</td>`;
                table += `<td><span class="text-muted"><i class="fa fa-clock-o"></i> ${bid['bid_date']}</span> </td>`;
                // Add button to accept the bid (if the user is the owner of the NFT)
                table += `<td><button type="button" class="waves-effect waves-light btn btn-success btn-xs" onclick="accept_bid(${bid['id']})">Accept</button></td>`;
                // Add button to reject the bid (if the user is the owner of the NFT)
                table += `<td><button type="button" class="waves-effect waves-light btn btn-danger btn-xs" onclick="reject_bid(${bid['id']})">Reject</button></td>`;
                table += '</tr>';
            }
            table += '</table>';
            $('#bids_table').html(table);
        },
        error: function(error) {
            console.error('Error:', error);
        }
    });
}



$('#validate_place_bid').click(function() {
        var bidAmount = $('#bid_amount').val();
        var nftId = '{{ nft_data['id'] }}';

        if ($.isNumeric(bidAmount) && bidAmount > 0) {
            bidAmount = parseFloat(bidAmount).toFixed(2);

            $.ajax({
                url: `/api/place_bid/${nftId}`,
                type: 'POST',
                contentType: 'application/json', // Indiquer que l'on envoie du JSON
                data: JSON.stringify({bid_amount: bidAmount}), // Convertir l'objet en chaîne JSON
                success: function(response) {
                    swal(response['status'], response['message'], response['status']);
                    get_bids(nftId);
                },
                error: function(response) {
                    swal(response['status'], response['message'], response['status']);
                }
            });
        } else {
            console.error('Invalid bid amount');
        }
    });




function owned_status(nft_id) {
    // Requête AJAX à l'API Flask
    $.ajax({
        url: `/api/owned_status/${nft_id}`,
        method: 'GET',
        success: function(response) {
            $('#owned_status').text(response['message']);
            // if field "owned" is true, add a button "Set as profile picture"
            if (response['owned'] === true) {
                $('#set_as_profile_picture').html('<a href="#" onclick="set_as_profile_picture({{ nft_data['id'] }})">'+response["set_profile_text"]+'</a>');
            }
            else {
                $('#set_as_profile_picture').html('');
            }
        },
        error: function(error) {
            console.error('Error:', error);
        }
    });
}

function set_as_profile_picture(nft_id) {
    $.ajax({
        url: `/api/set_as_profile_picture/${nft_id}`,
        method: 'GET',
        success: function(response) {
            // Supposons que response['image_path'] contienne le nouveau chemin de l'image
            var baseUrl = "{{ url_for('static', filename='') }}"; // Récupère la base de l'URL des fichiers statiques
            var newImagePath = baseUrl + response['image_path'] + '?v=' + new Date().getTime();
            $('#profile_picture_top_navbar').attr('src', newImagePath);

        },
        error: function(error) {
            console.error('Error:', error);
        }
    });
}


// Display the buy, sell or bid box depending on the status of the NFT
// if the user owned the NFT, display the sell box
// if the user doesn't own the NFT, but the NFT is for sale, display the buy box

function update_buy_sell_bid_box() {
    var nftData = $('#nft_data');
    var owned = nftData.data('owned') === 'True';
    var isForSale = nftData.data('is_for_sale') === 'True';
    if (owned) {
        $('#sell_box').show();
        $('#buy_box').hide();
    } else if (isForSale) {
        $('#buy_box').show();
        $('#sell_box').hide();

    }
}

$(document).ready(function() {
    // Get the owned status of the NFT
    owned_status({{ nft_data['id'] }});
    // Display the buy, sell or bid box depending on the status of the NFT
    update_buy_sell_bid_box({{ nft_data['id'] }});
    // Get the bids for this NFT
    get_bids({{ nft_data['id'] }});
});

</script>
</body>
</html>
